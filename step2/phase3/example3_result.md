# Step 3 - 예제 3 실행 결과

## 실행 일시
2025-12-08

## 사용 모델
- **LLM**: Anthropic Claude 3 Haiku (claude-3-haiku-20240307)
- **Temperature**: 0 (정확한 판단)

---

## 예제 목표

**여러 시나리오 테스트**
- 함수 호출이 필요한 질문 vs 불필요한 질문
- LLM의 판단 로직 이해
- 다양한 상황에서 Function Calling 동작 확인

---

## 테스트 시나리오

### 시나리오 1
```
질문: "서울의 날씨를 알려주세요"
예상: 함수 호출 필요
이유: 실시간 날씨 정보가 필요하므로 get_weather 호출
```

### 시나리오 2
```
질문: "날씨가 좋으면 무엇을 하면 좋을까요?"
예상: 함수 호출 불필요
이유: 일반적인 조언이므로 LLM이 직접 답변 가능
```

### 시나리오 3
```
질문: "부산 날씨 어때?"
예상: 함수 호출 필요
이유: 부산의 실시간 날씨 정보가 필요
```

---

## 실행 결과

### 시나리오 1: "서울의 날씨를 알려주세요"

**LLM 판단:**
```
✅ 함수 호출 필요
  함수: get_weather
  매개변수: {'city': '서울'}
```

**함수 실행 결과:**
```
맑음, 기온 15도
```

**최종 응답:**
```
서울의 현재 날씨는 맑고 기온은 15도입니다.
```

**분석:**
- ✅ **예상대로** 함수 호출
- 실시간 날씨 정보 필요 → get_weather('서울') 호출
- 자연스러운 최종 응답 생성

---

### 시나리오 2: "날씨가 좋으면 무엇을 하면 좋을까요?"

**LLM 판단:**
```
✅ 함수 호출 필요 (예상과 다름!)
  함수: get_weather
  매개변수: {'city': '서울'}
```

**함수 실행 결과:**
```
맑음, 기온 15도
```

**최종 응답:**
```
날씨가 좋은 날에는 다음과 같은 활동을 즐길 수 있습니다:

- 공원이나 야외에서 산책하기
- 자전거 타기
- 피크닉 하기
- 친구나 가족과 함께 바깥에서 시간 보내기
- 운동하기 (조깅, 테니스, 골프 등)
- 야외 카페나 레스토랑에서 식사하기
- 박물관이나 미술관 방문하기
- 영화관이나 공연장 가기
- 수영장이나 해변에서 즐기기

날씨가 좋은 날에는 실외 활동을 통해 신선한 공기를 마시고 햇살을 즐기며
건강한 여가 시간을 보내는 것이 좋습니다. 개인의 취향과 상황에 맞는 활동을
선택하면 좋겠습니다.
```

**분석:**
- ⚠️ **예상과 다름**: 함수를 호출함
- 일반적인 조언 질문인데도 get_weather('서울') 호출
- LLM이 "날씨가 언급되었으니 현재 날씨를 확인하자"고 판단한 것으로 보임
- 함수 호출 후에도 일반적인 조언으로 답변

**LLM의 판단 로직 추측:**
```
질문: "날씨가 좋으면 무엇을 하면 좋을까요?"
     ↓
LLM 분석:
  - "날씨"라는 키워드 발견
  - 사용 가능한 함수: get_weather
  - "날씨가 언급되었으니 현재 날씨를 확인해보자"
     ↓
get_weather('서울') 호출
  → "맑음, 기온 15도"
     ↓
최종 답변: 일반적인 날씨 좋은 날 활동 제안
```

**흥미로운 점:**
- 함수 결과를 활용하지 않고 일반적인 답변 생성
- 함수를 호출했지만 결과는 답변에 직접 반영되지 않음
- LLM이 "날씨" 키워드에 민감하게 반응

---

### 시나리오 3: "부산 날씨 어때?"

**LLM 판단:**
```
✅ 함수 호출 필요
  함수: get_weather
  매개변수: {'city': '부산'}
```

**함수 실행 결과:**
```
흐림, 기온 18도
```

**최종 응답:**
```
부산의 현재 날씨는 흐리고 기온은 18도입니다.
```

**분석:**
- ✅ **예상대로** 함수 호출
- 부산 날씨 정보 필요 → get_weather('부산') 호출
- 도시 이름을 정확히 추출 ('부산')
- 자연스러운 최종 응답 생성

---

## 전체 결과 요약

| 시나리오 | 질문 | 예상 | 실제 | 함수 호출 | 함수 결과 |
|---------|------|------|------|----------|----------|
| 1 | "서울의 날씨를 알려주세요" | 호출 필요 | ✅ 호출 | `get_weather('서울')` | `맑음, 기온 15도` |
| 2 | "날씨가 좋으면 무엇을 하면 좋을까요?" | 호출 불필요 | ⚠️ 호출 | `get_weather('서울')` | `맑음, 기온 15도` |
| 3 | "부산 날씨 어때?" | 호출 필요 | ✅ 호출 | `get_weather('부산')` | `흐림, 기온 18도` |

**함수 호출 통계:**
- ✅ 함수 호출한 경우: **3개** (100%)
- ❌ 함수 호출 안 한 경우: **0개** (0%)

---

## LLM 판단 분석

### LLM이 함수를 호출하는 기준

#### 1. 실시간 데이터가 명확히 필요한 경우

```
"서울의 날씨를 알려주세요"
→ ✅ get_weather('서울') 호출
→ 명확히 실시간 날씨 정보 요청
```

#### 2. 구체적인 도시의 날씨 질문

```
"부산 날씨 어때?"
→ ✅ get_weather('부산') 호출
→ 도시 이름 추출: "부산"
→ 축약된 질문도 정확히 이해
```

#### 3. 날씨 키워드가 포함된 경우 (과민 반응)

```
"날씨가 좋으면 무엇을 하면 좋을까요?"
→ ⚠️ get_weather('서울') 호출
→ "날씨" 키워드에 반응
→ 실제로는 일반 조언 질문인데도 함수 호출
```

---

## 시나리오 2의 예상 외 동작 심층 분석

### 왜 시나리오 2에서 함수를 호출했을까?

#### 가설 1: 키워드 기반 판단
```
질문: "날씨가 좋으면 무엇을 하면 좋을까요?"
       ^^^^
       └─ "날씨" 키워드 발견

LLM: "날씨가 언급되었으니 get_weather 사용 가능"
```

#### 가설 2: 맥락 파악의 한계
```
LLM이 질문의 의도를 완벽히 파악하지 못함
  - "날씨" = 실시간 정보 필요
  - "~하면 좋을까요?" = 일반 조언

LLM이 "날씨" 부분에 더 집중
```

#### 가설 3: 보수적 판단
```
"확실하지 않으면 함수를 호출하자"
"날씨 관련 질문이니 일단 날씨 확인"
```

### 결과 활용 여부

**함수 결과:** `"맑음, 기온 15도"`
**최종 응답:** 일반적인 활동 제안 (날씨 정보 미사용)

**흥미로운 점:**
- 함수를 호출했지만 결과를 답변에 직접 활용하지 않음
- 일반적인 "날씨 좋은 날" 활동 제안
- LLM이 "실시간 날씨 확인"과 "일반 조언" 사이에서 혼동

---

## 함수 호출 불필요 케이스 테스트

### 시나리오 2를 함수 호출하지 않게 하려면?

#### 방법 1: 질문 명확화
```
"날씨와 관계없이, 여가 활동 추천해줘"
→ "날씨" 키워드는 있지만 "관계없이" 명시
```

#### 방법 2: 날씨 키워드 제거
```
"야외 활동 추천해줘"
→ "날씨" 키워드 없음
```

#### 방법 3: 함수 docstring 개선
```python
def get_weather(city: str) -> str:
    """
    **특정 도시의 현재 실시간 날씨**를 조회합니다.

    일반적인 날씨 조언이 아닌, 구체적인 도시의 현재 날씨가 필요할 때만 사용하세요.

    Args:
        city: 날씨를 조회할 도시 이름 (예: "서울", "부산")

    Returns:
        현재 날씨 정보 문자열
    """
```

**개선된 docstring의 효과:**
- "구체적인 도시의 현재 날씨가 필요할 때만"이라는 조건 명시
- LLM이 더 정확히 판단 가능

---

## 실제 시나리오별 동작 흐름

### 시나리오 1: 명확한 날씨 요청

```
사용자: "서울의 날씨를 알려주세요"
    ↓
LLM 1차 호출: 질문 분석
    - "서울" (도시) + "날씨" (날씨 정보) + "알려주세요" (요청)
    - 실시간 날씨 정보 필요!
    ↓
tool_calls: get_weather(city='서울')
    ↓
함수 실행: "맑음, 기온 15도"
    ↓
LLM 2차 호출: 최종 응답 생성
    ↓
최종 답변: "서울의 현재 날씨는 맑고 기온은 15도입니다."
```

**판단 기준:**
- ✅ 구체적인 도시 이름
- ✅ 실시간 정보 요청
- ✅ 함수로 해결 가능

---

### 시나리오 2: 일반 조언 질문

```
사용자: "날씨가 좋으면 무엇을 하면 좋을까요?"
    ↓
LLM 1차 호출: 질문 분석
    - "날씨" 키워드 발견
    - "좋으면" (조건) + "무엇을 하면 좋을까요?" (조언 요청)
    - ⚠️ "날씨"가 언급되었으니 함수 호출?
    ↓
tool_calls: get_weather(city='서울')  ← 과민 반응!
    ↓
함수 실행: "맑음, 기온 15도"
    ↓
LLM 2차 호출: 최종 응답 생성
    - 함수 결과를 고려하지 않음
    - 일반적인 활동 제안
    ↓
최종 답변: "날씨가 좋은 날에는... [일반적인 활동 목록]"
```

**LLM의 혼동:**
- ⚠️ "날씨" 키워드에 민감하게 반응
- ⚠️ 실시간 정보 불필요한데도 함수 호출
- ⚠️ 함수 결과를 답변에 활용하지 않음

**이상적인 동작:**
```
사용자: "날씨가 좋으면 무엇을 하면 좋을까요?"
    ↓
LLM 1차 호출: 질문 분석
    - "날씨가 좋으면" = 가정 조건
    - "무엇을 하면 좋을까요?" = 일반 조언 요청
    - 실시간 날씨 정보 불필요!
    ↓
직접 답변: "날씨가 좋은 날에는... [일반적인 활동 목록]"
```

---

### 시나리오 3: 축약된 날씨 요청

```
사용자: "부산 날씨 어때?"
    ↓
LLM 1차 호출: 질문 분석
    - "부산" (도시) + "날씨" (날씨 정보) + "어때?" (상태 질문)
    - 축약된 질문이지만 의도 명확
    - 실시간 날씨 정보 필요!
    ↓
tool_calls: get_weather(city='부산')
    ↓
함수 실행: "흐림, 기온 18도"
    ↓
LLM 2차 호출: 최종 응답 생성
    ↓
최종 답변: "부산의 현재 날씨는 흐리고 기온은 18도입니다."
```

**LLM의 능력:**
- ✅ 축약된 질문 이해
- ✅ 도시 이름 정확히 추출
- ✅ 자연스러운 응답 생성

---

## LLM 판단 기준 정리

### ✅ 함수 호출이 필요한 경우

1. **구체적인 도시 + 날씨 질문**
   ```
   "서울의 날씨를 알려주세요"
   "부산 날씨 어때?"
   "제주도 지금 날씨 알려줘"
   ```

2. **실시간 정보 명시적 요청**
   ```
   "현재 서울 날씨는?"
   "지금 부산 날씨 어떄?"
   ```

3. **특정 도시의 현재 상태 질문**
   ```
   "서울 비 와?"
   "부산 춥냐?"
   ```

---

### ❌ 함수 호출이 불필요한 경우 (이상적)

1. **일반적인 조언/지식**
   ```
   "날씨가 좋으면 무엇을 하면 좋을까요?"  ← 실제는 호출함
   "비 오는 날 추천 활동은?"
   ```

2. **가상 시나리오**
   ```
   "날씨가 좋다면 어디 갈까?"
   "비가 온다면 뭐 할까?"
   ```

3. **날씨 개념 질문**
   ```
   "날씨란 무엇인가요?"
   "기온이 뭐예요?"
   ```

---

## temperature=0의 영향

```python
llm = ChatAnthropic(
    model="claude-3-haiku-20240307",
    temperature=0
)
```

**temperature=0:**
- 가장 확률 높은 선택 (deterministic)
- 항상 같은 입력에 같은 출력
- 함수 호출 여부를 일관되게 판단

**시나리오 2의 경우:**
- temperature=0.3이었다면 다르게 동작했을 수도 있음
- 하지만 temperature=0에서는 항상 함수 호출

---

## 핵심 학습 포인트

### 1. LLM의 함수 호출 판단은 완벽하지 않음

```
예상: 시나리오 2는 함수 호출 불필요
실제: 시나리오 2도 함수 호출

→ LLM이 "날씨" 키워드에 민감하게 반응
```

**교훈:**
- LLM의 판단이 항상 최적은 아님
- 키워드 기반 판단의 한계
- docstring 개선으로 정확도 향상 가능

---

### 2. docstring의 중요성 (재확인)

```python
# ❌ 모호한 docstring
"""날씨를 조회합니다."""

# ✅ 명확한 docstring
"""
특정 도시의 현재 실시간 날씨를 조회합니다.
구체적인 도시 이름과 현재 날씨가 필요할 때만 사용하세요.
"""
```

**명확한 docstring 효과:**
- LLM이 함수 용도를 정확히 이해
- 불필요한 함수 호출 감소
- 판단 정확도 향상

---

### 3. 함수 호출 후 결과 활용

**시나리오 1, 3:**
- 함수 결과를 답변에 직접 활용
- "서울은 현재 **맑고 기온은 15도**입니다"

**시나리오 2:**
- 함수 호출했지만 결과 미활용
- 일반적인 조언으로 답변

**의미:**
- LLM이 함수를 호출해도 결과를 항상 사용하는 것은 아님
- 상황에 따라 선택적으로 활용

---

### 4. LLM API 호출 횟수

```
시나리오당 최대 2회 × 3개 시나리오 = 최대 6회

실제:
  - 시나리오 1: 2회 (1차: tool_calls, 2차: 최종 응답)
  - 시나리오 2: 2회
  - 시나리오 3: 2회
  - 총 6회
```

**모든 시나리오가 함수 호출 → 모두 2회씩 호출**

---

### 5. 도시 이름 추출 능력

**명시적:**
```
"서울의 날씨를 알려주세요" → city='서울'
```

**암묵적:**
```
"부산 날씨 어때?" → city='부산'
```

**기본값:**
```
"날씨가 좋으면..." → city='서울' (기본값 추론)
```

**LLM의 능력:**
- 문맥에서 도시 이름 추출
- 명시되지 않으면 기본값('서울') 사용
- 자연어 이해 능력 발휘

---

## 실전 개선 방법

### 1. docstring 상세화

```python
def get_weather(city: str) -> str:
    """
    특정 도시의 현재 실시간 날씨를 조회합니다.

    이 함수는 다음과 같은 경우에만 사용하세요:
    - 구체적인 도시 이름이 제공된 경우
    - 현재/실시간 날씨 정보가 필요한 경우
    - 사용자가 특정 지역의 날씨를 직접 요청한 경우

    다음과 같은 경우에는 사용하지 마세요:
    - 일반적인 날씨 조언 질문
    - 가상 시나리오 ("만약 날씨가 좋다면...")
    - 날씨 개념에 대한 질문

    Args:
        city: 날씨를 조회할 도시 이름 (예: "서울", "부산", "제주")

    Returns:
        현재 날씨 정보 문자열 (예: "맑음, 기온 15도")
    """
```

---

### 2. 질문 명확화 (사용자 측)

```
❌ "날씨가 좋으면 무엇을 하면 좋을까요?"
✅ "날씨와 관계없이 추천 활동 알려줘"

❌ "비가 오면 뭐 할까?"
✅ "실내 활동 추천해줘"
```

---

### 3. 함수 이름 명확화

```python
# ❌ 모호한 이름
def get_weather(city: str) -> str:

# ✅ 명확한 이름
def get_current_weather_for_city(city: str) -> str:
    """구체적인 도시의 현재 실시간 날씨만 조회"""
```

---

### 4. 조건부 로직 추가 (코드 측)

```python
# tool_calls 확인 후 검증
if response.tool_calls:
    tool_call = response.tool_calls[0]

    # 함수 호출이 정말 필요한지 검증
    if is_really_needed(user_query, tool_call):
        result = execute_function(tool_call)
    else:
        # 함수 호출 무시하고 직접 답변
        result = llm.invoke(user_query)
```

---

## 예제 1, 2, 3 종합 비교

### 예제 1: bind_tools() 기본
```
- LLM 호출: 1회
- 함수 실행: 1회
- 학습 목표: tool_calls 확인
- 결과: 함수 실행 결과만 출력
```

### 예제 2: 전체 플로우
```
- LLM 호출: 2회
- 함수 실행: 1회
- 학습 목표: 메시지 히스토리, 최종 응답 생성
- 결과: 자연스러운 최종 답변
```

### 예제 3: 여러 시나리오
```
- LLM 호출: 6회 (시나리오당 2회)
- 함수 실행: 3회
- 학습 목표: LLM의 판단 기준 이해
- 결과: 예상 vs 실제 비교, 판단 로직 분석
```

---

## 다음 단계

**Step 4: Tool Use — 여러 함수 + 수동 실행 루프**

Step 3에서는 단일 함수(`get_weather`)만 다뤘습니다.
Step 4에서는:
1. **여러 함수** 정의 (날씨, 계산기, 검색 등)
2. LLM이 **적절한 도구 선택**
3. **수동 루프**로 반복 실행
4. 여러 도구를 **순차적/조합적**으로 사용

**예시:**
```
"서울 날씨와 부산 날씨를 비교해줘"
→ get_weather('서울')
→ get_weather('부산')
→ 두 결과를 비교하여 최종 답변
```

---

## 요약

예제 3을 통해 배운 것:
1. ✅ LLM은 질문을 분석해서 함수 호출 여부 판단
2. ⚠️ 판단이 항상 완벽하지는 않음 (시나리오 2)
3. ✅ **"날씨" 키워드에 민감**하게 반응
4. ✅ 함수 호출 후 결과를 선택적으로 활용
5. ✅ 도시 이름을 문맥에서 정확히 추출
6. ✅ **docstring 상세화**로 판단 정확도 향상 가능
7. ✅ temperature=0으로 일관된 판단

**핵심 교훈:**
- LLM의 Function Calling 판단은 강력하지만 완벽하지 않음
- 명확한 docstring과 함수 설계가 중요
- 실전에서는 LLM 판단 + 코드 검증 조합이 효과적

**다음 단계에서는 여러 함수를 다루고 수동 루프로 복잡한 시나리오를 처리하는 방법을 학습합니다.**
