# Step 3 - 예제 4 실행 결과

## 실행 일시
2025-12-08

## 사용 모델
- **LLM**: Anthropic Claude 3 Haiku (claude-3-haiku-20240307)
- **Temperature**: 0 (정확한 판단)

---

## 예제 목표

**함수 호출이 불필요한 질문 테스트**
- 날씨 함수가 필요 없는 질문들로 테스트
- LLM이 직접 답변하는 케이스 확인
- 예제 3과 비교하여 LLM 판단 기준 명확히 이해

---

## 테스트 시나리오

| # | 질문 | 예상 | 이유 |
|---|------|------|------|
| 1 | "날씨란 무엇인가요?" | 함수 호출 불필요 | 날씨의 개념/정의 (일반 지식) |
| 2 | "파이썬으로 Hello World를 출력하는 방법은?" | 함수 호출 불필요 | 날씨와 무관한 프로그래밍 질문 |
| 3 | "오늘 점심 메뉴 추천해줘" | 함수 호출 불필요 | 음식 추천 (날씨 함수와 무관) |
| 4 | "기온이 뭐예요?" | 함수 호출 불필요 | 기온의 개념 설명 (일반 지식) |
| 5 | "어제 서울 날씨 어땠어?" | 함수 호출 불필요 | 과거 날씨 (현재 날씨만 제공) |

---

## 실행 결과

### 시나리오 1: "날씨란 무엇인가요?"

**LLM 판단:**
```
✅ 함수 호출 불필요 (예상대로!)
```

**직접 응답:**
```
날씨란 특정 지역의 대기 상태를 나타내는 것으로, 온도, 강수량, 바람, 습도 등
다양한 기상 요소로 구성됩니다. 날씨는 시간과 장소에 따라 계속 변화하며,
이러한 변화는 우리의 일상생활에 많은 영향을 미칩니다. 날씨 정보는 일상생활
계획 수립, 농업, 교통, 레저 활동 등 다양한 분야에서 활용됩니다. 날씨에 대한
이해와 예측은 우리 삶의 질을 높이는 데 중요한 역할을 합니다.
```

**분석:**
- ✅ **예상대로** 직접 답변
- 개념/정의 질문 → 일반 지식으로 답변 가능
- 실시간 데이터 불필요
- 완벽한 케이스!

---

### 시나리오 2: "파이썬으로 Hello World를 출력하는 방법은?"

**LLM 판단:**
```
⚠️  함수 호출 필요 (예상과 다름!)
  함수: get_code
  매개변수: {'language': 'python', 'task': 'print hello world'}
```

**분석:**
- ⚠️ **예상과 다름**: 함수 호출 시도
- ⚠️ **중요**: LLM이 **존재하지 않는 함수를 호출**함 (환각 Hallucination)
- `get_code`라는 함수는 정의되지 않았음
- 날씨와 무관한데도 함수 호출 시도

**LLM의 판단 로직 추측:**
```
질문: "파이썬으로 Hello World를 출력하는 방법은?"
     ↓
LLM 분석:
  - 코드 생성 요청
  - "코드 생성 함수가 있을 것 같다"
  - get_code() 함수 호출 시도 (환각!)
     ↓
실제: get_code 함수는 존재하지 않음
      (bind_tools에 get_weather만 바인딩됨)
```

**중요한 발견:**
- LLM은 **함수 목록을 무시하고 새로운 함수를 만들어낼 수 있음**
- 이는 Function Calling의 **환각(Hallucination)** 문제
- 실전에서는 함수 이름 검증 필수!

---

### 시나리오 3: "오늘 점심 메뉴 추천해줘"

**LLM 판단:**
```
⚠️  함수 호출 필요 (예상과 다름!)
  함수: get_weather
  매개변수: {'city': '서울'}
```

**분석:**
- ⚠️ **예상과 다름**: get_weather 호출
- 음식 추천인데 날씨 함수를 호출
- "오늘"이라는 키워드에 반응한 것으로 추측
- LLM이 "날씨에 따라 음식을 추천하려고" 판단했을 가능성

**LLM의 판단 로직 추측:**
```
질문: "오늘 점심 메뉴 추천해줘"
     ↓
LLM 분석:
  - "오늘" → 현재 시점
  - 사용 가능한 함수: get_weather
  - "날씨를 확인해서 날씨에 맞는 음식을 추천하자"
     ↓
get_weather('서울') 호출
```

**문제점:**
- 사용자는 날씨 기반 추천을 요청하지 않음
- LLM이 과도하게 추론
- 함수 호출이 질문 의도와 불일치

---

### 시나리오 4: "기온이 뭐예요?"

**LLM 판단:**
```
⚠️  함수 호출 필요 (예상과 다름!)
  함수: get_weather
  매개변수: {'city': '서울'}
```

**분석:**
- ⚠️ **예상과 다름**: get_weather 호출
- "기온"이라는 날씨 관련 키워드에 민감 반응
- 개념 설명 질문인데 실시간 데이터 조회 시도
- 시나리오 1 ("날씨란 무엇인가요?")과 대조적

**시나리오 1 vs 4 비교:**

| 시나리오 | 질문 | 결과 | 차이점 |
|---------|------|------|--------|
| 1 | "날씨란 무엇인가요?" | ✅ 직접 답변 | "날씨란" = 정의 요청이 명확 |
| 4 | "기온이 뭐예요?" | ⚠️ 함수 호출 | "기온" = 측정 가능한 값으로 해석? |

**LLM의 혼동:**
- "날씨란" → 개념 설명으로 명확히 인식
- "기온이 뭐예요?" → 현재 기온 요청으로 오해

---

### 시나리오 5: "어제 서울 날씨 어땠어?"

**LLM 판단:**
```
⚠️  함수 호출 필요 (예상과 다름!)
  함수: get_weather
  매개변수: {'city': '서울'}
```

**분석:**
- ⚠️ **예상과 다름**: get_weather 호출
- **과거 날씨** 요청인데 **현재 날씨** 함수 호출
- LLM이 시제(과거/현재)를 구별하지 못함
- 함수 docstring에 "현재 날씨"라고 명시되어 있는데도 호출

**함수 docstring:**
```python
"""
지정된 도시의 현재 날씨를 조회합니다.
         ^^^^
         └─ "현재"라고 명시
"""
```

**LLM의 판단 로직:**
```
질문: "어제 서울 날씨 어땠어?"
     ↓
LLM 분석:
  - "서울" (도시) + "날씨" (날씨 정보)
  - 사용 가능한 함수: get_weather
  - "날씨 관련 질문이니 호출하자"
  - ⚠️ "어제" (과거 시제)를 무시
     ↓
get_weather('서울') 호출 (현재 날씨)
```

**문제점:**
- 시제 구별 실패 (어제 vs 현재)
- 함수가 제공할 수 없는 정보를 요청
- docstring의 "현재" 키워드 무시

---

## 전체 결과 요약

| # | 질문 | 예상 | 실제 | 함수 호출 |
|---|------|------|------|----------|
| 1 | "날씨란 무엇인가요?" | 직접 답변 | ✅ 직접 답변 | - |
| 2 | "파이썬으로 Hello World를 출력하는 방법은?" | 직접 답변 | ⚠️ 함수 호출 | `get_code()` (환각!) |
| 3 | "오늘 점심 메뉴 추천해줘" | 직접 답변 | ⚠️ 함수 호출 | `get_weather('서울')` |
| 4 | "기온이 뭐예요?" | 직접 답변 | ⚠️ 함수 호출 | `get_weather('서울')` |
| 5 | "어제 서울 날씨 어땠어?" | 직접 답변 | ⚠️ 함수 호출 | `get_weather('서울')` |

**통계:**
- ✅ 직접 답변: **1개** (20%)
- ⚠️ 함수 호출: **4개** (80%)

**예상과 실제의 불일치율: 80%**

---

## 예제 3 vs 예제 4 비교

### 예제 3: 날씨 관련 질문

| 시나리오 | 질문 | 예상 | 실제 |
|---------|------|------|------|
| 1 | "서울의 날씨를 알려주세요" | 함수 호출 | ✅ 함수 호출 |
| 2 | "날씨가 좋으면 무엇을 하면 좋을까요?" | 직접 답변 | ⚠️ 함수 호출 |
| 3 | "부산 날씨 어때?" | 함수 호출 | ✅ 함수 호출 |

**결과:** 3개 모두 함수 호출 (예상 일치율: 67%)

---

### 예제 4: 날씨 무관 질문

| 시나리오 | 질문 | 예상 | 실제 |
|---------|------|------|------|
| 1 | "날씨란 무엇인가요?" | 직접 답변 | ✅ 직접 답변 |
| 2 | "파이썬으로 Hello World를 출력하는 방법은?" | 직접 답변 | ⚠️ 함수 호출 (환각) |
| 3 | "오늘 점심 메뉴 추천해줘" | 직접 답변 | ⚠️ 함수 호출 |
| 4 | "기온이 뭐예요?" | 직접 답변 | ⚠️ 함수 호출 |
| 5 | "어제 서울 날씨 어땠어?" | 직접 답변 | ⚠️ 함수 호출 |

**결과:** 1개만 직접 답변 (예상 일치율: 20%)

---

## 핵심 발견

### 1. 함수 환각(Hallucination)

```
질문: "파이썬으로 Hello World를 출력하는 방법은?"
     ↓
LLM: get_code(language='python', task='print hello world') 호출
     ↓
실제: get_code 함수는 존재하지 않음!
```

**의미:**
- LLM이 바인딩되지 않은 함수를 만들어낼 수 있음
- bind_tools([get_weather])만 했는데 get_code 호출 시도
- **실전에서는 함수 이름 검증 필수**

**대응 방법:**
```python
if response.tool_calls:
    tool_call = response.tool_calls[0]

    # 함수 이름 검증
    if tool_call['name'] not in ['get_weather']:
        print(f"⚠️  알 수 없는 함수: {tool_call['name']}")
        # 직접 답변으로 전환
    else:
        # 함수 실행
        result = get_weather(**tool_call['args'])
```

---

### 2. 키워드 과민 반응

**날씨 관련 키워드가 있으면 함수 호출 경향:**
- "기온" → get_weather 호출
- "오늘" → get_weather 호출
- "점심 메뉴" → get_weather 호출 (날씨 무관인데도!)

**유일하게 직접 답변한 케이스:**
- "날씨란 무엇인가요?" → "~란" 형식의 정의 요청이 명확

---

### 3. 시제 구별 실패

```
"어제 서울 날씨 어땠어?" (과거)
     ↓
get_weather(city='서울') 호출 (현재 날씨 함수)
```

**문제점:**
- LLM이 "어제"(과거)를 인식하지 못함
- 함수 docstring에 "현재 날씨"라고 명시되어 있는데도 무시
- 함수로 답변할 수 없는 질문에 함수 호출

---

### 4. 과도한 추론

```
"오늘 점심 메뉴 추천해줘"
     ↓
get_weather('서울') 호출
```

**LLM의 추론:**
- "날씨에 따라 음식을 추천하려고 했을 것"
- 사용자가 요청하지 않은 기능 수행
- 함수 호출이 질문 의도와 불일치

---

## LLM이 직접 답변하는 유일한 케이스

### ✅ "날씨란 무엇인가요?"

**성공 요인:**
1. **"~란" 형식**: 정의/개념 요청이 명확
2. **실시간 데이터 불필요**: 일반 지식으로 답변 가능
3. **함수와 무관한 추상적 질문**: 구체적 도시/시간 없음

**교훈:**
- 정의/개념 질문은 함수 호출 안 함
- "~란 무엇인가요?" 형식이 가장 안전

---

## docstring 개선 제안

### 현재 docstring

```python
def get_weather(city: str) -> str:
    """
    지정된 도시의 현재 날씨를 조회합니다.

    Args:
        city: 날씨를 조회할 도시 이름

    Returns:
        날씨 정보 문자열
    """
```

**문제점:**
- "현재"라고 명시했지만 과거 날씨 질문에도 호출됨
- 사용 조건이 불명확

---

### 개선된 docstring

```python
def get_weather(city: str) -> str:
    """
    특정 도시의 현재 실시간 날씨만 조회합니다.

    ⚠️  이 함수는 다음 경우에만 사용하세요:
    - 구체적인 도시 이름이 제공된 경우
    - "지금", "현재"와 같이 현재 시점을 명시한 경우
    - 실시간 날씨 정보가 명확히 필요한 경우

    ⚠️  다음 경우에는 사용하지 마세요:
    - 과거 날씨 ("어제", "지난주")
    - 미래 날씨 ("내일", "다음주")
    - 날씨 개념 설명 ("날씨란", "기온이란")
    - 날씨와 무관한 질문 (음식, 코딩 등)

    Args:
        city: 날씨를 조회할 도시 이름 (예: "서울", "부산")
              반드시 현재 시점의 날씨 요청이어야 함

    Returns:
        현재 날씨 정보 문자열 (예: "맑음, 기온 15도")
    """
```

**개선 포인트:**
1. "⚠️ 사용하지 마세요" 섹션 추가
2. 과거/미래 시제 명시적 제외
3. 개념 질문 제외 명시
4. 날씨 무관 질문 제외 명시

---

## 실전 대응 전략

### 1. 함수 이름 검증

```python
ALLOWED_FUNCTIONS = ['get_weather']

if response.tool_calls:
    tool_call = response.tool_calls[0]

    if tool_call['name'] not in ALLOWED_FUNCTIONS:
        print(f"⚠️  허용되지 않은 함수: {tool_call['name']}")
        # 환각 방지: 직접 답변으로 전환
        response = llm.invoke(user_query)
```

---

### 2. 시제 검증

```python
PAST_KEYWORDS = ['어제', '지난', '작년', '~ 전']
FUTURE_KEYWORDS = ['내일', '다음', '내년', '~ 후']

def should_call_function(query, tool_call):
    # 과거/미래 시제 체크
    for keyword in PAST_KEYWORDS + FUTURE_KEYWORDS:
        if keyword in query:
            return False  # 함수 호출 금지

    return True
```

---

### 3. 의도 검증

```python
CONCEPT_PATTERNS = ['란 무엇', '이 뭐', '의 정의', '이란']

def is_concept_question(query):
    return any(pattern in query for pattern in CONCEPT_PATTERNS)

if is_concept_question(user_query):
    # 개념 질문 → 직접 답변
    response = llm.invoke(user_query)
else:
    # 실시간 데이터 질문 → 함수 호출 가능
    response = llm_with_tools.invoke(user_query)
```

---

## temperature=0의 영향

**temperature=0:**
- 가장 확률 높은 선택만
- 항상 동일한 판단
- 예제 4의 결과는 매번 동일하게 재현됨

**만약 temperature > 0 이었다면:**
- 일부 시나리오에서 다른 판단 가능
- 하지만 전반적인 경향은 유사할 것

---

## 핵심 학습 포인트

### 1. LLM의 판단은 불완전함

```
예상: 5개 모두 직접 답변
실제: 1개만 직접 답변 (4개 함수 호출)
```

**교훈:**
- LLM을 100% 신뢰하면 안 됨
- 코드 레벨에서 검증 필요

---

### 2. 함수 환각(Hallucination) 발생

```
get_code() 호출 시도
→ 실제로는 존재하지 않는 함수!
```

**교훈:**
- 함수 이름 검증 필수
- 허용된 함수 목록 관리

---

### 3. 시제 구별 실패

```
"어제 날씨" → 현재 날씨 함수 호출
```

**교훈:**
- 시제 키워드 체크 필요
- docstring에 명확히 명시

---

### 4. 유일하게 성공한 케이스: 정의 질문

```
"날씨란 무엇인가요?" → ✅ 직접 답변
```

**교훈:**
- "~란" 형식의 정의 질문은 안전
- 개념 설명 질문은 함수 호출 안 함

---

### 5. docstring 상세화 필요

**현재:** "지정된 도시의 현재 날씨를 조회합니다"
**개선:** "⚠️ 사용하지 마세요" 섹션 추가

---

## 예제 1~4 종합 정리

| 예제 | 목표 | 핵심 학습 |
|------|------|----------|
| **1** | bind_tools() 기본 | tool_calls 확인 |
| **2** | 전체 플로우 | 메시지 히스토리, 최종 응답 |
| **3** | 날씨 관련 질문 | LLM 판단 (예상 67% 일치) |
| **4** | 날씨 무관 질문 | LLM 판단 한계 (예상 20% 일치) |

---

## 다음 단계

**Step 3 완료!**

**Step 4: Tool Use — 여러 함수 + 수동 실행 루프**
- 여러 도구 정의 (날씨, 계산기, 검색)
- LLM이 적절한 도구 자동 선택
- 수동 루프로 반복 실행
- 함수 검증 로직 추가 (환각 방지)

---

## 요약

예제 4를 통해 배운 것:
1. ⚠️ **함수 환각**: LLM이 존재하지 않는 함수 호출 시도 (get_code)
2. ⚠️ **키워드 과민**: 날씨 관련 키워드에 과도하게 반응
3. ⚠️ **시제 무시**: 과거 날씨 질문에 현재 날씨 함수 호출
4. ⚠️ **과도한 추론**: 음식 추천에 날씨 함수 호출
5. ✅ **유일한 성공**: 정의 질문 ("~란 무엇인가요?")
6. ✅ **실전 대응**: 함수 이름 검증, 시제 검증, 의도 검증 필수

**핵심 교훈:**
- **LLM의 Function Calling 판단은 완벽하지 않음**
- **함수 환각(Hallucination) 발생 가능**
- **코드 레벨 검증 필수** (함수 이름, 시제, 의도)
- **docstring을 더 상세하게** 작성하여 정확도 향상
- **실전에서는 LLM 판단 + 코드 검증 조합**

**Step 3의 4개 예제로 Function Calling의 동작 원리와 한계를 모두 이해했습니다!**
